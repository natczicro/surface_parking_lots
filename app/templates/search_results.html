<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

    <style>
        body { font-family: Arial, sans-serif; }
        .results { margin-top: 20px; }
        button.calc-btn { padding:4px 8px; font-size:13px; cursor:pointer; }
    </style>
</head>
<body>

<h1>Surface Parking Lots Near Metro Stations in {{ city }}</h1>
<div class="results" id="results"></div>

<table id="stations-table" class="display">
    <thead>
        <tr>
            <th>Station Name</th>
            <th>Total Parking Lot Area (m²)</th>
            <th>Map</th>
            <th>Calculate</th> <!-- ➤ new column -->
        </tr>
    </thead>

    <tbody>
        {% for station in stations %}
        <tr data-station="{{ station }}">
            <td>{{ station }}</td>
            <td class="area-result">Pending...</td>
            <td>
                <a href="/map?station_name={{ station }}&city={{ city }}" target="_blank">Map</a>
            </td>
            <td>
                <button class="calc-btn" data-station="{{ station }}">Calculate</button>  <!-- ➤ button added -->
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<a href="/">Go back</a>

<script>
$(document).ready(function () {

    // Sorting properly even when values are updated dynamically
    $.fn.dataTable.ext.type.order['area-sort-pre'] = function (data) {
        if (data === 'Error' || data === 'Pending...') return -1;
        const num = parseFloat(data);
        return isNaN(num) ? -1 : num;
    };

    const table = $('#stations-table').DataTable({
        paging:false, searching:true, ordering:true, info:false,
        columnDefs:[ { targets:1, type:'area-sort' } ]
    });

    // ➤ Handle individual calculation by button click
    $(document).on('click', '.calc-btn', function () {
        const station = $(this).data('station');
        const row = $(`tr[data-station="${station}"]`);
        const cell = row.find('.area-result');

        cell.text("Calculating...");

        $.post('/get_parking_lots', {
            station_name: station,
            city: "{{ city }}",
            radius: 500
        }).then(response => {
            cell.text(response.total_area_m2.toFixed(2));
            table.cell(cell).invalidate('dom');
            table.draw();  // resort after update
        }).catch(() => {
            cell.text("Error");
            table.cell(cell).invalidate('dom');
        });
    });

});
</script>

</body>
</html>
